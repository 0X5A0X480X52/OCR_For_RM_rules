# æ–‡æœ¬æ¸…æ´—ä¸èšåˆæµç¨‹è¯´æ˜

## æ¦‚è¿°

æœ¬æ¨¡å—åœ¨åŸå§‹ PDF æå–è¾“å‡ºï¼ˆ`pages/*.json`ï¼‰åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡åŠ å·¥ï¼Œå®ç°ï¼š

1. **ä¸€çº§æ¸…æ´—ï¼ˆChunkçº§ï¼‰**: è¿‡æ»¤å™ªå£°ã€åˆå¹¶æ–­è¡Œã€è¯†åˆ«æ ‡é¢˜/åˆ—è¡¨ï¼Œç”Ÿæˆè¯­ä¹‰è¿ç»­çš„ chunks
2. **äºŒçº§èšåˆï¼ˆSectionçº§ï¼‰**: å°† heading ä¹‹é—´çš„å†…å®¹æ‰“åŒ…ä¸º sectionsï¼Œä¾¿äºåç»­ ES ç´¢å¼•å’Œè¯­ä¹‰æ£€ç´¢

## æ ¸å¿ƒä¼˜åŒ–

### å™ªå£°è¿‡æ»¤

- é¡µè„š/é¡µçœ‰ï¼š`"Â© 2025 å¤§ç–† ç‰ˆæƒæ‰€æœ‰"` ç­‰ç‰ˆæƒä¿¡æ¯
- ä½ç½®ä¿¡åº¦å›¾ç‰‡ OCRï¼š`ocr_confidence < 0.1` çš„å™ªå£°èŠ‚ç‚¹
- çº¯æ•°å­—é¡µç å’Œåˆ†éš”çº¿

### æ ‡é¢˜è¯†åˆ«ï¼ˆä¼˜å…ˆçº§é€’å‡ï¼‰

1. **å…³é”®è¯å‘½ä¸­**ï¼šé™„å½•ã€ç« ã€èŠ‚ã€è¯´æ˜ã€æµç¨‹ã€è§„åˆ™ã€å¤„ç½šç­‰
2. **ç¼–å·æ ·å¼**ï¼š`ç¬¬Xç« `ã€`X.Y`ã€`(ä¸€)`ã€`â‘ ` ç­‰
3. **çŸ­è¡Œåˆ¤æ–­**ï¼šé•¿åº¦ < 20 å­—ç¬¦ä¸”ä¸ä»¥å¥æœ«æ ‡ç‚¹ç»“å°¾
4. **å­—å·çªå˜**ï¼š`bbox_height` ä¸å¹³å‡é«˜åº¦æ¯”å€¼ > 1.3

### åˆ—è¡¨èšåˆ

- **å‰ç¼€è¯†åˆ«**ï¼š`â€¢`ã€`-`ã€`1.`ã€`(a)` ç­‰åˆ—è¡¨ç¬¦å·
- **ç¼©è¿›ä¸è¡Œè·**ï¼šç»“åˆ `bbox.left` å’Œè¡Œé—´è·åˆ¤æ–­åˆ—è¡¨å±‚çº§

### å¥å­çº§æ–­è£‚ä¿®å¤

- è´ªå©ªåˆå¹¶ç­–ç•¥ï¼šé»˜è®¤åˆå¹¶ç›¸é‚»æ–‡æœ¬è¡Œ
- å¼ºæ–­å¼€æ¡ä»¶ï¼š
  - æ ‡é¢˜è¾¹ç•Œ
  - åˆ—è¡¨èµ·å§‹
  - æ®µé—´è· > 15px
  - ä¸Šä¸€è¡Œä»¥å¥æœ«æ ‡ç‚¹ï¼ˆã€‚ï¼ï¼Ÿï¼šï¼‰ç»“å°¾ä¸”å½“å‰è¡Œéç»­æ¥è¯

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šä¸»æµç¨‹ä¸­å¯ç”¨æ¸…æ´—

```powershell
# å®Œæ•´æµç¨‹ï¼ˆPDF â†’ OCR â†’ åˆ†æ®µ â†’ æ¸…æ´—èšåˆ â†’ ESï¼‰
python main.py --clean

# ç¦»çº¿æµç¨‹ï¼ˆè·³è¿‡ESï¼‰
python main.py --no-es --clean
```

### æ–¹å¼äºŒï¼šç¦»çº¿æ¸…æ´—å·²æœ‰è¾“å‡º

```powershell
# å•ä¸ªPDFç›®å½•
python main.py --clean-only "output\quick_run_test\RoboMaster 2026 æœºç”²å¤§å¸ˆè¶…çº§å¯¹æŠ—èµ›æ¯”èµ›è§„åˆ™æ‰‹å†ŒV1.0.0ï¼ˆ20251021ï¼‰"

# æ•´ä¸ªä»»åŠ¡ç›®å½•ï¼ˆè‡ªåŠ¨éå†æ‰€æœ‰PDFå­ç›®å½•ï¼‰
python main.py --clean-only "output\quick_run_test"
```

### æ–¹å¼ä¸‰ï¼šç›´æ¥è°ƒç”¨æ¸…æ´—å™¨

```powershell
python src\text_cleaner.py "output\quick_run_test\RoboMaster 2026 æœºç”²å¤§å¸ˆè¶…çº§å¯¹æŠ—èµ›æ¯”èµ›è§„åˆ™æ‰‹å†ŒV1.0.0ï¼ˆ20251021ï¼‰"
```

## è¾“å‡ºæ–‡ä»¶

### `cleaned_chunks.json`

ä¸€çº§æ¸…æ´—ç»“æœï¼ŒåŒ…å«ï¼š

- `chunks[]`: è¯­ä¹‰è¿ç»­çš„æ–‡æœ¬å—æ•°ç»„
  - `id`: chunk ID
  - `content`: åˆå¹¶åçš„æ–‡æœ¬å†…å®¹
  - `type`: `heading` | `paragraph` | `list_item`
  - `source_pages`: æ¥æºé¡µç åˆ—è¡¨
  - `bbox_range`: ç©ºé—´èŒƒå›´ï¼ˆleft, top, right, bottomï¼‰
  - `confidence_avg`: å¹³å‡ OCR ç½®ä¿¡åº¦
  - `node_count`: åˆå¹¶çš„åŸå§‹èŠ‚ç‚¹æ•°
  - `meta`: å…ƒä¿¡æ¯ï¼ˆé¦–é¡µ/æœ«é¡µ/ç¼©è¿›/é«˜åº¦ï¼‰

### `cleaned_basic_part.json`

äºŒçº§èšåˆç»“æœï¼ŒåŒ…å«ï¼š

- `sections[]`: æŒ‰ heading åˆ†ç»„çš„æ®µè½æ•°ç»„
  - `heading`: æ ‡é¢˜æ–‡æœ¬
  - `content`: å®Œæ•´å†…å®¹ï¼ˆMarkdown æ ¼å¼ï¼Œ`## heading` + æ®µè½ï¼‰
  - `source_pages`: é¡µç èŒƒå›´
  - `page_range`: `{first, last}` é¡µç 
  - `chunk_count`: åŒ…å«çš„ chunk æ•°é‡
  - `chunk_types`: chunk ç±»å‹ç»Ÿè®¡
  - `heading_chunk_id`: æ ‡é¢˜ chunk ID
  - `content_chunk_ids`: å†…å®¹ chunk ID åˆ—è¡¨

### `cleaner.log`

å®¡è®¡æ—¥å¿—ï¼Œè®°å½•ï¼š

- é¡µè„š/é¡µçœ‰è¿‡æ»¤è®°å½•
- ä½ç½®ä¿¡åº¦èŠ‚ç‚¹ä¸¢å¼ƒè®°å½•
- æ¯ä¸ª chunk åˆ›å»ºåŸå› ï¼ˆheading/list/gap/sentence_endï¼‰
- ç»Ÿè®¡ä¿¡æ¯ï¼ˆé¡µæ•°ã€èŠ‚ç‚¹æ•°ã€chunkæ•°ã€typesåˆ†å¸ƒï¼‰

## é…ç½®å‚æ•°

åœ¨ `src/text_cleaner.py` æˆ–è°ƒç”¨æ—¶ä¿®æ”¹ï¼š

```python
TextCleaner(
    confidence_threshold=0.1,      # OCRç½®ä¿¡åº¦é˜ˆå€¼
    short_line_threshold=20,       # çŸ­è¡Œå­—ç¬¦æ•°é˜ˆå€¼ï¼ˆæ ‡é¢˜åˆ¤æ–­ï¼‰
    height_ratio_threshold=1.3,    # å­—å·çªå˜å€æ•°ï¼ˆæ ‡é¢˜åˆ¤æ–­ï¼‰
    min_gap_threshold=15.0,        # æ®µé—´è·é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
    log_file=Path("cleaner.log")   # æ—¥å¿—æ–‡ä»¶è·¯å¾„
)
```

## æ•ˆæœç¤ºä¾‹

### åŸå§‹ `pages/page_002.json` èŠ‚ç‚¹ï¼ˆéƒ¨åˆ†ï¼‰

```
node 1: "çŸ¥è¯†äº§æƒå£°æ˜ RoboMaster ç»„å§”ä¼š..."
node 2: "2    Â© 2025 å¤§ç–† ç‰ˆæƒæ‰€æœ‰"  â† é¡µè„šå™ªå£°
node 3: "é˜…è¯»æç¤º"
node 4: "RoboMaster æ¯”èµ›ä¸ºæœºå™¨äººèµ›äº‹..."
```

### æ¸…æ´—å `cleaned_chunks.json`ï¼ˆéƒ¨åˆ†ï¼‰

```json
{
  "id": 10,
  "type": "heading",
  "content": "çŸ¥è¯†äº§æƒå£°æ˜ RoboMaster ç»„å§”ä¼šï¼ˆRMOCï¼ŒRoboMaster Organizing Committeeï¼‰é¼“åŠ±å¹¶å€¡å¯¼æŠ€æœ¯åˆ›æ–°...",
  "source_pages": [2],
  "chunk_count": 3
},
{
  "id": 15,
  "type": "heading",
  "content": "é˜…è¯»æç¤º",
  "source_pages": [2],
  "chunk_count": 1
}
```

**é¡µè„šå·²è¿‡æ»¤**ï¼Œæ ‡é¢˜è‡ªåŠ¨è¯†åˆ«å¹¶åˆç†åˆ†å—ã€‚

### èšåˆå `cleaned_basic_part.json`ï¼ˆéƒ¨åˆ†ï¼‰

```json
{
  "heading": "çŸ¥è¯†äº§æƒå£°æ˜ RoboMaster ç»„å§”ä¼š...",
  "content": "## çŸ¥è¯†äº§æƒå£°æ˜ RoboMaster ç»„å§”ä¼š...\n\nå‚èµ›é˜Ÿä¼æ¯”èµ›ä¸­å¼€å‘çš„æ‰€æœ‰çŸ¥è¯†äº§æƒ...",
  "source_pages": [2],
  "page_range": {"first": 2, "last": 2},
  "chunk_count": 4,
  "chunk_types": {"paragraph": 4}
}
```

heading ä¸åç»­å†…å®¹æ‰“åŒ…ä¸º sectionï¼Œä¾¿äº ES å­˜å‚¨å’Œæ£€ç´¢ã€‚

## åç»­å·¥ä½œ

### å·²å®Œæˆ

- âœ… é¡µè„š/é¡µçœ‰è¿‡æ»¤ï¼ˆç‰ˆæƒä¿¡æ¯ã€é¡µç ï¼‰
- âœ… æ ‡é¢˜è¯†åˆ«ï¼ˆå…³é”®è¯+çŸ­è¡Œ+å­—å·+ç¼–å·ï¼‰
- âœ… åˆ—è¡¨èšåˆï¼ˆå‰ç¼€+ç¼©è¿›ï¼‰
- âœ… å¥å­çº§æ–­è£‚ä¿®å¤
- âœ… äºŒçº§èšåˆï¼ˆsection æ‰“åŒ…ï¼‰
- âœ… å®¡è®¡æ—¥å¿—è®°å½•

### å¾…ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

- ğŸ”„ è¡¨æ ¼å†…å®¹ç»“æ„åŒ–ä¿ç•™ï¼ˆå½“å‰è¡¨æ ¼æ–‡æœ¬å·²æå–ä½†æœªä¿ç•™åˆ—ç»“æ„ï¼‰
- ğŸ”„ å›¾æ³¨/è„šæ³¨ç‰¹æ®Šå¤„ç†ï¼ˆå½“å‰ä¸æ­£æ–‡æ··åˆï¼‰
- ğŸ”„ å…¬å¼/ä»£ç å—è¯†åˆ«ï¼ˆå¦‚éœ€è¦ï¼‰
- ğŸ”„ è·¨é¡µè¡¨æ ¼/åˆ—è¡¨è¿ç»­æ€§æ£€æµ‹
- ğŸ”„ åŸºäºå­—ä½“æ ·å¼çš„ç²¾ç»†åŒ–åˆå¹¶ï¼ˆéœ€è¡¥å…… `blocks.font_name/font_size` åˆ° `nodes`ï¼‰

## é›†æˆåˆ° ES æµç¨‹

æ¸…æ´—åçš„ `cleaned_basic_part.json` å¯ç›´æ¥ç”¨äº ES ç´¢å¼•ï¼š

```python
# ä¼ªä»£ç ç¤ºä¾‹
for section in sections:
    es_doc = {
        "doc_id": section["heading"],
        "content": section["content"],
        "source_pages": section["source_pages"],
        "page_range": section["page_range"],
        # ... å…¶ä»–å…ƒä¿¡æ¯
    }
    es_client.index(doc=es_doc)
```

æˆ–ä½¿ç”¨ç°æœ‰ `chunks` ç›´æ¥ç´¢å¼•ï¼ˆæ›´ç»†ç²’åº¦ï¼‰ã€‚
