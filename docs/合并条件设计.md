# 合并条件设计

> **目标**仅是：让“语义上相邻的语段”合理聚合，用于 Elasticsearch 检索
> 不追求 100% 还原原文排版或段落**

在这个前提下，其实**问题一下子就从“难题”降级成了“成熟工程问题”**。

下面我**不讲空泛理论**，而是直接：

1️⃣ 解释你这段 PyMuPDF 原始文本为什么会这样
2️⃣ 给出一套**“足够成熟、可落地、已被大量项目验证”的恢复思路**
3️⃣ 用你的文本**现场示例说明如何聚合**

---

## 一、先看清你现在拿到的“原始文本”本质是什么

你给的文本（节选）：

```
附录 1 赛前流程说明 
 本赛季将不单独设置哨兵建图环节。 
预检录 
组委会将在预检录和适应性训练尽可能帮助参赛队伍检查机器人问题，但检录结果不代表后续正式比赛的
检录结果，若后续正式比赛检录出现机器人不满足检录通过标准的情况，则机器人依然无法上场比赛。 
仅预检录期间可以进行唯一标识登记，预检录阶段结束后，仅可进行已有唯一标识的机器人更换补登记。 
```

**这是典型的 PDF → 文本后的三种“断裂来源”叠加：**

### 1️⃣ 自动换行（排版断裂）

```text
但检录结果不代表后续正式比赛的
检录结果
```

👉 这是**同一语义句子，被硬换行拆开**

---

### 2️⃣ 视觉段落 ≠ 语义段落

```text
预检录 
组委会将在预检录和适应性训练尽可能帮助……
```

👉 “预检录”在视觉上是一个标题
👉 PyMuPDF 不知道它是标题，只知道“单独一行”

---

### 3️⃣ 列表符号被打散

```text
 非紧急情况报备方式：
 紧急情况报备方式：
```

👉 PDF 里是列表
👉 文本里只是“特殊字符 + 换行”

---

## 二、在你这个目标下，**真正需要做的只有三件事**

> **不是“恢复原文档结构”
> 而是：构造“检索友好语义块”**

### ✔ 我给你一个明确的工程定义

> **一个 ES 文档块 = 一个“语义连续、主题一致、长度适中”的文本单元**

---

## 三、成熟、可复用的恢复策略（工业常用）

### ✅ 总体策略一句话版

> **先粗暴合并，再用强信号切断**

这是业界在法规 / 规则 / 手册里最常用的套路。

---

## 四、具体可执行规则（非常关键）

下面这套规则，**你可以 1:1 写进代码**。

---

### 🔹 Rule 1：先“贪婪合并”相邻文本行（核心）

**只要不满足“强断开条件”，就合并。**

#### 默认合并条件

* 上一行不以 `。！？:` 结尾 → 合并
* 下一行不是明显标题 → 合并
* 下一行不是列表起始 → 合并

👉 这一步直接解决 **90% 的断行问题**

---

### 🔹 Rule 2：标题是“强语义边界”

#### 典型标题特征（命中一个就行）：

* 行长度短（< 15 字）
* 不以标点结尾
* 包含关键词：`附录 / 第 / 章 / 节 / 说明`
* 全角空格多 / 居中（可选）

#### 例如：

```text
附录 1 赛前流程说明
预检录
场地道具训练
```

👉 **这些必须单独开块**

---

### 🔹 Rule 3：列表项是“半独立语义块”

```text
 非紧急情况报备方式：
若距离参赛队下一场比赛超过2 小时，……
```

处理方式：

👉 **列表标题 + 后续说明合并为一个块**

---

### 🔹 Rule 4：句子级断裂必须修复（ES 非常重要）

```text
情况，则机器人依然无法上场比赛。
```

这类必须合并到上一段，否则 ES 会严重降权。

---

## 五、用你的文本，给你一个“理想聚合结果示例”

### 原始（你现在有的）

```
预检录 
组委会将在预检录和适应性训练尽可能帮助参赛队伍检查机器人问题，但检录结果不代表后续正式比赛的
检录结果，若后续正式比赛检录出现机器人不满足检录通过标准的情况，则机器人依然无法上场比赛。 
仅预检录期间可以进行唯一标识登记，预检录阶段结束后，仅可进行已有唯一标识的机器人更换补登记。 
```

---

### 🔹 聚合后（非常适合 ES）

```text
预检录  
组委会将在预检录和适应性训练中尽可能帮助参赛队伍检查机器人问题，但检录结果不代表后续正式比赛的检录结果。若后续正式比赛检录出现机器人不满足检录通过标准的情况，则机器人依然无法上场比赛。仅预检录期间可以进行唯一标识登记，预检录阶段结束后，仅可进行已有唯一标识的机器人更换补登记。
```

👉 **语义完整**
👉 **长度适中**
👉 **检索命中率极高**
